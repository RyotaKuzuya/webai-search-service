name: AI Auto Test & Improvement

on:
  # å®šæœŸå®Ÿè¡Œï¼ˆæ¯Žæ—¥æ·±å¤œ2æ™‚ï¼‰
  schedule:
    - cron: '0 17 * * *'  # UTC 17:00 = JST 02:00
  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:
    inputs:
      test_type:
        description: 'ãƒ†ã‚¹ãƒˆã‚¿ã‚¤ãƒ—'
        required: true
        type: choice
        options:
          - 'full'      # å…¨ä½“ãƒ†ã‚¹ãƒˆ
          - 'security'  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆ
          - 'performance' # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
          - 'usability' # ä½¿ã„ã‚„ã™ã•ãƒ†ã‚¹ãƒˆ
          - 'code-quality' # ã‚³ãƒ¼ãƒ‰å“è³ª

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: read

jobs:
  app-health-check:
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.check.outputs.status }}
      issues_found: ${{ steps.check.outputs.issues_found }}
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          pip install requests beautifulsoup4 pytest selenium webdriver-manager
          
      - name: Health Check Script
        id: check
        run: |
          cat > health_check.py << 'EOF'
          import requests
          import json
          import time
          from datetime import datetime
          
          results = {
              "timestamp": datetime.now().isoformat(),
              "checks": {},
              "issues": []
          }
          
          # 1. APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯
          endpoints = [
              ("http://localhost:8001/health", "Simple API"),
              ("http://localhost:8003/health", "Session API"),
              ("http://localhost:5000/", "Web UI")
          ]
          
          for url, name in endpoints:
              try:
                  response = requests.get(url, timeout=5)
                  results["checks"][name] = {
                      "status": response.status_code,
                      "response_time": response.elapsed.total_seconds(),
                      "healthy": response.status_code == 200
                  }
                  if response.status_code != 200:
                      results["issues"].append(f"{name} returned {response.status_code}")
              except Exception as e:
                  results["checks"][name] = {
                      "status": 0,
                      "error": str(e),
                      "healthy": False
                  }
                  results["issues"].append(f"{name} is down: {str(e)}")
          
          # 2. ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ ãƒã‚§ãƒƒã‚¯
          slow_endpoints = [
              (name, check["response_time"]) 
              for name, check in results["checks"].items() 
              if check.get("response_time", 0) > 2.0
          ]
          
          if slow_endpoints:
              results["issues"].append(f"Slow endpoints: {slow_endpoints}")
          
          # 3. ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ãƒã‚§ãƒƒã‚¯
          try:
              with open("simple_api.log", "r") as f:
                  recent_logs = f.readlines()[-100:]
                  error_count = sum(1 for line in recent_logs if "ERROR" in line)
                  if error_count > 10:
                      results["issues"].append(f"High error rate: {error_count} errors in recent logs")
          except:
              pass
          
          # çµæžœã‚’ä¿å­˜
          with open("health_check_results.json", "w") as f:
              json.dump(results, f, indent=2)
          
          # GitHub Actionsã®å‡ºåŠ›
          has_issues = len(results["issues"]) > 0
          print(f"::set-output name=status::{'unhealthy' if has_issues else 'healthy'}")
          print(f"::set-output name=issues_found::{json.dumps(results['issues'])}")
          
          EOF
          
          python health_check.py || echo "Health check completed with issues"
          
  ai-analysis:
    needs: app-health-check
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Create Analysis Issue
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ needs.app-health-check.outputs.status }}' || 'unknown';
            const issues = ${{ needs.app-health-check.outputs.issues_found || '[]' }};
            const testType = '${{ github.event.inputs.test_type }}' || 'full';
            
            // åˆ†æžç”¨ã®Issueã‚’ä½œæˆ
            const issueBody = `## ðŸ¤– AIè‡ªå‹•ãƒ†ã‚¹ãƒˆãƒ»è©•ä¾¡ãƒ¬ãƒãƒ¼ãƒˆ
            
            **å®Ÿè¡Œæ™‚åˆ»**: ${new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' })}
            **ãƒ†ã‚¹ãƒˆã‚¿ã‚¤ãƒ—**: ${testType}
            **ã‚¢ãƒ—ãƒªçŠ¶æ…‹**: ${status}
            
            ### æ¤œå‡ºã•ã‚ŒãŸå•é¡Œ
            ${issues.length > 0 ? issues.map(issue => `- ${issue}`).join('\n') : 'å•é¡Œã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ'}
            
            ### AIã«ã‚ˆã‚‹åˆ†æžä¾é ¼
            
            @claude ä»¥ä¸‹ã®åˆ†æžã¨æ”¹å–„ã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„ï¼š
            
            1. **ç¾çŠ¶åˆ†æž**
               - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å¥å…¨æ€§è©•ä¾¡
               - æ¤œå‡ºã•ã‚ŒãŸå•é¡Œã®åŽŸå› åˆ†æž
               - æ½œåœ¨çš„ãªãƒªã‚¹ã‚¯ã®ç‰¹å®š
            
            2. **æ”¹å–„ææ¡ˆ**
               - å³åº§ã«å®Ÿæ–½ã™ã¹ãä¿®æ­£
               - ä¸­é•·æœŸçš„ãªæ”¹å–„è¨ˆç”»
               - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹æœ€é©åŒ–ã®ææ¡ˆ
            
            3. **å®Ÿè£…**
               - ç·Šæ€¥åº¦ã®é«˜ã„å•é¡Œã®ä¿®æ­£ã‚³ãƒ¼ãƒ‰
               - ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã®è¿½åŠ 
               - ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ›´æ–°
            
            4. **ãƒ†ã‚¹ãƒˆã‚¿ã‚¤ãƒ—åˆ¥ã®è¿½åŠ åˆ†æž** (${testType})
            ${testType === 'security' ? `
               - SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–ã®ç¢ºèª
               - XSSè„†å¼±æ€§ã®ãƒã‚§ãƒƒã‚¯
               - èªè¨¼ãƒ»èªå¯ã®å•é¡Œ
               - ã‚»ã‚­ãƒ¥ã‚¢ãªè¨­å®šã®ç¢ºèª
            ` : ''}
            ${testType === 'performance' ? `
               - ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ ã®æœ€é©åŒ–
               - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªã®åŠ¹çŽ‡åŒ–
               - ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã®ææ¡ˆ
               - ãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨é‡ã®å‰Šæ¸›
            ` : ''}
            ${testType === 'usability' ? `
               - UIã®æ”¹å–„ç‚¹
               - ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ”¹å–„
               - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ­ãƒ¼ã®æœ€é©åŒ–
               - ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ã®å‘ä¸Š
            ` : ''}
            ${testType === 'code-quality' ? `
               - ã‚³ãƒ¼ãƒ‰ã®é‡è¤‡é™¤åŽ»
               - é–¢æ•°ã®è¤‡é›‘åº¦å‰Šæ¸›
               - ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã®å‘ä¸Š
               - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ææ¡ˆ
            ` : ''}
            
            æ”¹å–„å®Ÿæ–½å¾Œã€PRã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
            `;
            
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ¤– AIè‡ªå‹•æ”¹å–„: ${testType} - ${new Date().toLocaleDateString('ja-JP')}`,
              body: issueBody,
              labels: ['ai-improvement', 'priority:high', testType]
            });
            
            console.log(`Created issue: ${issue.data.html_url}`);
            
  automated-tests:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Test Environment
        run: |
          # ãƒ†ã‚¹ãƒˆç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
          docker-compose -f docker-compose.test.yml up -d || echo "No test compose file"
          
      - name: Run Automated Tests
        run: |
          cat > run_tests.py << 'EOF'
          import subprocess
          import json
          import os
          
          test_results = {
              "unit_tests": {"passed": 0, "failed": 0, "errors": []},
              "integration_tests": {"passed": 0, "failed": 0, "errors": []},
              "security_tests": {"passed": 0, "failed": 0, "vulnerabilities": []},
              "performance_tests": {"metrics": {}}
          }
          
          # 1. ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
          if os.path.exists("tests/"):
              try:
                  result = subprocess.run(
                      ["python", "-m", "pytest", "tests/", "-v", "--json-report"],
                      capture_output=True,
                      text=True
                  )
                  # çµæžœã‚’ãƒ‘ãƒ¼ã‚¹
              except:
                  test_results["unit_tests"]["errors"].append("No unit tests found")
          
          # 2. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆ
          security_checks = [
              ("SQL Injection", "grep -r \"f\\\".*{.*}.*\\\"\" --include=\"*.py\""),
              ("Hardcoded Secrets", "grep -r \"password.*=.*['\\\"]\" --include=\"*.py\""),
              ("Insecure Random", "grep -r \"random\\.\" --include=\"*.py\"")
          ]
          
          for check_name, command in security_checks:
              try:
                  result = subprocess.run(command, shell=True, capture_output=True, text=True)
                  if result.stdout:
                      test_results["security_tests"]["vulnerabilities"].append({
                          "type": check_name,
                          "occurrences": len(result.stdout.strip().split('\n'))
                      })
              except:
                  pass
          
          # 3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
          performance_tests = [
              ("API Response Time", "curl -w \"@curl-format.txt\" -o /dev/null -s http://localhost:8001/health"),
              ("Memory Usage", "ps aux | grep python | awk '{sum+=$4} END {print sum}'")
          ]
          
          for test_name, command in performance_tests:
              try:
                  result = subprocess.run(command, shell=True, capture_output=True, text=True)
                  test_results["performance_tests"]["metrics"][test_name] = result.stdout.strip()
              except:
                  pass
          
          # çµæžœã‚’ä¿å­˜
          with open("test_results.json", "w") as f:
              json.dump(test_results, f, indent=2)
          
          print("Test results saved to test_results.json")
          EOF
          
          python run_tests.py
          
      - name: Upload Test Results
        uses: actions/upload-artifact@v3
        with:
          name: test-results
          path: |
            health_check_results.json
            test_results.json
            
  create-improvement-pr:
    needs: [app-health-check, ai-analysis]
    runs-on: ubuntu-latest
    if: needs.app-health-check.outputs.status == 'unhealthy'
    
    steps:
      - name: Create Improvement Branch
        run: |
          BRANCH_NAME="ai-improvement-$(date +%Y%m%d-%H%M%S)"
          git checkout -b $BRANCH_NAME
          
          # åŸºæœ¬çš„ãªæ”¹å–„ã‚’å®Ÿæ–½
          cat > auto_improvements.py << 'EOF'
          import os
          import re
          
          # 1. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®æ”¹å–„
          def improve_error_handling(file_path):
              with open(file_path, 'r') as f:
                  content = f.read()
              
              # try-exceptãƒ–ãƒ­ãƒƒã‚¯ã®è¿½åŠ 
              improved = re.sub(
                  r'def\s+(\w+)\((.*?)\):\n((?:(?!\ndef\s).*\n)*)',
                  lambda m: f'def {m.group(1)}({m.group(2)}):\n    try:\n{m.group(3)}    except Exception as e:\n        logger.error(f"Error in {m.group(1)}: {{e}}")\n        raise\n',
                  content
              )
              
              with open(file_path, 'w') as f:
                  f.write(improved)
          
          # 2. ãƒ­ã‚°ã®è¿½åŠ 
          def add_logging(file_path):
              # å®Ÿè£…çœç•¥
              pass
          
          # 3. åž‹ãƒ’ãƒ³ãƒˆã®è¿½åŠ 
          def add_type_hints(file_path):
              # å®Ÿè£…çœç•¥
              pass
          
          # æ”¹å–„ã‚’å®Ÿè¡Œ
          for root, dirs, files in os.walk('.'):
              for file in files:
                  if file.endswith('.py'):
                      file_path = os.path.join(root, file)
                      print(f"Improving {file_path}")
                      # improve_error_handling(file_path)
          
          EOF
          
          python auto_improvements.py || echo "Auto improvements completed"
          
          # å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
          git add -A
          git commit -m "ðŸ¤– AIè‡ªå‹•æ”¹å–„: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨ãƒ­ã‚°ã®å¼·åŒ–"
          git push origin $BRANCH_NAME