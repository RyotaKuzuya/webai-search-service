name: Claude Auto Issue Resolver

on:
  # æ—¥æœ¬æ™‚é–“ã®å¤œé–“ï¼ˆ23:00-06:00ï¼‰ã«30åˆ†ã”ã¨ã«å®Ÿè¡Œ
  schedule:
    - cron: '0,30 14-21 * * *'  # UTC 14:00-21:30 = JST 23:00-06:30
    - cron: '0 22 * * *'        # UTC 22:00 = JST 07:00 (æœ€çµ‚ãƒã‚§ãƒƒã‚¯)
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  find-and-process-issues:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Find unprocessed issues
        id: find-issues
        uses: actions/github-script@v7
        with:
          script: |
            // claude-processedãƒ©ãƒ™ãƒ«ãŒãªã„ã€å„ªå…ˆåº¦ãƒ©ãƒ™ãƒ«ä»˜ãã®issueã‚’æ¤œç´¢
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              sort: 'created',
              direction: 'asc'
            });
            
            // å„ªå…ˆåº¦ã§ã‚½ãƒ¼ãƒˆï¼ˆhigh > middle > lowï¼‰
            const priorityOrder = { 'priority:high': 1, 'priority:middle': 2, 'priority:low': 3 };
            const unprocessedIssues = issues.data
              .filter(issue => {
                const labels = issue.labels.map(l => l.name);
                return !labels.includes('claude-processed') && 
                       labels.some(l => l.startsWith('priority:'));
              })
              .sort((a, b) => {
                const aPriority = a.labels.find(l => l.name.startsWith('priority:'))?.name || 'priority:low';
                const bPriority = b.labels.find(l => l.name.startsWith('priority:'))?.name || 'priority:low';
                return (priorityOrder[aPriority] || 999) - (priorityOrder[bPriority] || 999);
              });
            
            if (unprocessedIssues.length > 0) {
              const issue = unprocessedIssues[0];
              console.log(`Found issue #${issue.number}: ${issue.title}`);
              core.setOutput('issue_number', issue.number);
              core.setOutput('issue_title', issue.title);
              core.setOutput('has_issue', 'true');
            } else {
              console.log('No unprocessed issues found');
              core.setOutput('has_issue', 'false');
            }
            
      - name: Process issue with Claude
        if: steps.find-issues.outputs.has_issue == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.find-issues.outputs.issue_number }};
            const issueTitle = "${{ steps.find-issues.outputs.issue_title }}";
            
            // Issueã®è©³ç´°ã‚’å–å¾—
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });
            
            // Claudeã¸ã®ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ä»˜ãã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
            const comment = `@claude 

ã“ã®Issueã€Œ${issueTitle}ã€ã‚’è§£æ±ºã—ã¦ãã ã•ã„ã€‚

Issueå†…å®¹:
${issue.data.body}

ä»¥ä¸‹ã®æ‰‹é †ã§å¯¾å¿œã—ã¦ãã ã•ã„ï¼š
1. å•é¡Œã‚’åˆ†æ
2. è§£æ±ºç­–ã‚’ææ¡ˆ
3. å¯èƒ½ã§ã‚ã‚Œã°ã‚³ãƒ¼ãƒ‰ã®ä¿®æ­£ã‚’å®Ÿæ–½
4. PRã‚’ä½œæˆï¼ˆå¿…è¦ãªå ´åˆï¼‰`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: comment
            });
            
            // claude-code-requestedãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['claude-code-requested']
            });
            
            console.log(`Requested Claude to process issue #${issueNumber}`);
            
      - name: Summary
        if: always()
        run: |
          if [[ "${{ steps.find-issues.outputs.has_issue }}" == "true" ]]; then
            echo "âœ… Issue #${{ steps.find-issues.outputs.issue_number }} ã‚’Claudeã«å‡¦ç†ä¾é ¼ã—ã¾ã—ãŸ"
          else
            echo "ğŸ“ å‡¦ç†å¯¾è±¡ã®Issueã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
          fi