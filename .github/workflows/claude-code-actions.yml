name: Claude Code Actions

on:
  # Issueã‚³ãƒ¡ãƒ³ãƒˆã§@claudeãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã•ã‚ŒãŸæ™‚
  issue_comment:
    types: [created]
  # PRã‚³ãƒ¡ãƒ³ãƒˆã§@claudeãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã•ã‚ŒãŸæ™‚  
  pull_request_review_comment:
    types: [created]
  # PRãŒä½œæˆãƒ»æ›´æ–°ã•ã‚ŒãŸæ™‚
  pull_request:
    types: [opened, synchronize, reopened]
  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:
    inputs:
      prompt:
        description: 'Claudeã«å®Ÿè¡Œã•ã›ã‚‹ã‚¿ã‚¹ã‚¯'
        required: true
        type: string
      
permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: read

jobs:
  claude-code:
    runs-on: ubuntu-latest
    # @claudeãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹å ´åˆã®ã¿å®Ÿè¡Œ
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request') ||
      (github.event_name == 'workflow_dispatch')
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install Claude CLI
        run: |
          # Claude CLIã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
          echo "Claude CLI is assumed to be available in the Action environment"
          
      - name: Process with Claude
        env:
          CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
          # ã¾ãŸã¯OAuthãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨
          CLAUDE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          # ã‚³ãƒ¡ãƒ³ãƒˆå†…å®¹ã‚’å–å¾—
          if [[ "${{ github.event_name }}" == "issue_comment" ]]; then
            PROMPT="${{ github.event.comment.body }}"
          elif [[ "${{ github.event_name }}" == "pull_request_review_comment" ]]; then
            PROMPT="${{ github.event.comment.body }}"
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            PROMPT="ã“ã®PRã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ã€æ”¹å–„ç‚¹ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚"
          else
            PROMPT="${{ github.event.inputs.prompt }}"
          fi
          
          # @claudeãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
          PROMPT=$(echo "$PROMPT" | sed 's/@claude//g')
          
          # Claudeã®å¿œç­”ã‚’å–å¾—ï¼ˆå®Ÿéš›ã®å®Ÿè£…ã«å¿œã˜ã¦èª¿æ•´ï¼‰
          echo "Processing prompt: $PROMPT"
          
          # çµæœã‚’ç’°å¢ƒå¤‰æ•°ã«ä¿å­˜
          echo "CLAUDE_RESPONSE=Claudeã®å¿œç­”ãŒã“ã“ã«å…¥ã‚Šã¾ã™" >> $GITHUB_ENV
          
      - name: Comment on Issue
        if: github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          script: |
            const response = process.env.CLAUDE_RESPONSE || 'Claudeã‹ã‚‰ã®å¿œç­”ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚';
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ¤– Claude Code Response\n\n${response}`
            });
            
      - name: Comment on PR
        if: github.event_name == 'pull_request' || github.event_name == 'pull_request_review_comment'
        uses: actions/github-script@v7
        with:
          script: |
            const response = process.env.CLAUDE_RESPONSE || 'Claudeã‹ã‚‰ã®å¿œç­”ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚';
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ¤– Claude Code Review\n\n${response}`
            });
            
      - name: Add processed label
        if: github.event_name == 'issue_comment' || github.event_name == 'pull_request_review_comment'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['claude-processed']
            });