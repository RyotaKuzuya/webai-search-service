name: Claude Local Runner

on:
  workflow_dispatch:
    inputs:
      task:
        description: 'Claude ã«å®Ÿè¡Œã•ã›ã‚‹ã‚¿ã‚¹ã‚¯'
        required: true
        type: choice
        options:
          - 'code-review'
          - 'bug-fix'
          - 'performance-optimization'
          - 'security-check'
          - 'dependency-update'
          - 'custom'
      custom_prompt:
        description: 'ã‚«ã‚¹ã‚¿ãƒ ã‚¿ã‚¹ã‚¯ã®å ´åˆã®è©³ç´°ãªæŒ‡ç¤º'
        required: false
        type: string
      model:
        description: 'ä½¿ç”¨ã™ã‚‹ãƒ¢ãƒ‡ãƒ«'
        required: false
        type: choice
        default: 'sonnet4'
        options:
          - 'opus4'
          - 'sonnet4'
          - 'sonnet'
          - 'haiku'

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: write

jobs:
  run-claude-locally:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Install dependencies
        run: |
          pip install requests flask
          
      - name: Create Claude task script
        run: |
          cat > run_claude_task.py << 'EOF'
          import subprocess
          import sys
          import os
          import json
          from datetime import datetime
          
          def run_claude_task(task_type, custom_prompt="", model="sonnet4"):
              prompts = {
                  "code-review": """
                  WebAIãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
                  ä»¥ä¸‹ã®è¦³ç‚¹ã§ãƒã‚§ãƒƒã‚¯ï¼š
                  1. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®å•é¡Œ
                  2. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®æ”¹å–„ç‚¹
                  3. ã‚³ãƒ¼ãƒ‰å“è³ª
                  4. ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã®éµå®ˆ
                  
                  simple_api.py, simple_app.py, claude_simple_session_api.pyã‚’é‡ç‚¹çš„ã«ç¢ºèªã—ã¦ãã ã•ã„ã€‚
                  """,
                  
                  "bug-fix": """
                  WebAIãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ—¢çŸ¥ã®ãƒã‚°ã‚„å•é¡Œã‚’èª¿æŸ»ã—ã€ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚
                  ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚‚ç¢ºèªã—ã€æ½œåœ¨çš„ãªå•é¡Œã‚‚ç‰¹å®šã—ã¦ãã ã•ã„ã€‚
                  """,
                  
                  "performance-optimization": """
                  WebAIãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’æœ€é©åŒ–ã—ã¦ãã ã•ã„ã€‚
                  1. ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ã®æ”¹å–„
                  2. ãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨é‡ã®å‰Šæ¸›
                  3. ä¸¦è¡Œå‡¦ç†ã®æœ€é©åŒ–
                  """,
                  
                  "security-check": """
                  WebAIãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
                  1. SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–
                  2. XSSå¯¾ç­–
                  3. èªè¨¼ãƒ»èªå¯ã®ç¢ºèª
                  4. ã‚»ã‚­ãƒ¥ã‚¢ãªè¨­å®šã®ç¢ºèª
                  """,
                  
                  "dependency-update": """
                  requirements.txtã®ä¾å­˜é–¢ä¿‚ã‚’ç¢ºèªã—ã€å¿…è¦ã«å¿œã˜ã¦æ›´æ–°ã—ã¦ãã ã•ã„ã€‚
                  ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚’å„ªå…ˆã—ã¦ãã ã•ã„ã€‚
                  """
              }
              
              # ã‚¿ã‚¹ã‚¯ã«å¿œã˜ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’é¸æŠ
              if task_type == "custom":
                  prompt = custom_prompt or "WebAIãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æ”¹å–„ã—ã¦ãã ã•ã„ã€‚"
              else:
                  prompt = prompts.get(task_type, "WebAIãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æ”¹å–„ã—ã¦ãã ã•ã„ã€‚")
              
              print(f"ğŸš€ Claude Local Runner - {datetime.now()}")
              print(f"ã‚¿ã‚¹ã‚¯: {task_type}")
              print(f"ãƒ¢ãƒ‡ãƒ«: {model}")
              print("-" * 60)
              
              # Claudeã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œï¼ˆå®Ÿéš›ã®ç’°å¢ƒã§ã¯é©åˆ‡ãªãƒ‘ã‚¹ã¨èªè¨¼ãŒå¿…è¦ï¼‰
              try:
                  # ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã®Claudeå®Ÿè¡Œã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
                  print(f"\nğŸ“ å®Ÿè¡Œã™ã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ:\n{prompt}\n")
                  
                  # å®Ÿéš›ã«ã¯ã“ã“ã§Claude CLIã‚’å‘¼ã³å‡ºã™
                  # result = subprocess.run(['claude', prompt, '--model', model], 
                  #                       capture_output=True, text=True)
                  
                  # GitHub Actionsç’°å¢ƒã§ã®ä»£æ›¿å‡¦ç†
                  output = f"""
                  ## ã‚¿ã‚¹ã‚¯å®Ÿè¡Œãƒ¬ãƒãƒ¼ãƒˆ
                  
                  ### å®Ÿè¡Œå†…å®¹
                  - ã‚¿ã‚¹ã‚¯: {task_type}
                  - ãƒ¢ãƒ‡ãƒ«: {model}
                  - å®Ÿè¡Œæ™‚åˆ»: {datetime.now()}
                  
                  ### çµæœ
                  Claude CLIãŒGitHub Actionsç’°å¢ƒã§åˆ©ç”¨ã§ããªã„ãŸã‚ã€ãƒ­ãƒ¼ã‚«ãƒ«ã§å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š
                  
                  ```bash
                  cd /home/ubuntu/webai
                  claude "{prompt.replace('"', '\\"')}" --model {model}
                  ```
                  
                  ### æ¨å¥¨äº‹é …
                  1. ã‚»ãƒ«ãƒ•ãƒ›ã‚¹ãƒˆãƒ©ãƒ³ãƒŠãƒ¼ã®è¨­å®š
                  2. ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã®å®šæœŸå®Ÿè¡Œ
                  3. APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆçµŒç”±ã§ã®å®Ÿè¡Œ
                  """
                  
                  print(output)
                  
                  # çµæœã‚’ä¿å­˜
                  with open('claude_task_result.md', 'w', encoding='utf-8') as f:
                      f.write(output)
                  
              except Exception as e:
                  print(f"âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
                  sys.exit(1)
          
          if __name__ == "__main__":
              task = os.environ.get('TASK_TYPE', 'code-review')
              custom = os.environ.get('CUSTOM_PROMPT', '')
              model = os.environ.get('MODEL', 'sonnet4')
              
              run_claude_task(task, custom, model)
          EOF
          
      - name: Execute Claude task
        env:
          TASK_TYPE: ${{ github.event.inputs.task }}
          CUSTOM_PROMPT: ${{ github.event.inputs.custom_prompt }}
          MODEL: ${{ github.event.inputs.model }}
        run: python run_claude_task.py
        
      - name: Upload results
        uses: actions/upload-artifact@v3
        with:
          name: claude-task-results
          path: claude_task_result.md
          
      - name: Create issue with results
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const taskType = '${{ github.event.inputs.task }}';
            const timestamp = new Date().toISOString();
            
            let resultContent = 'ã‚¿ã‚¹ã‚¯çµæœã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
            try {
              resultContent = fs.readFileSync('claude_task_result.md', 'utf8');
            } catch (e) {
              console.error('Result file not found:', e);
            }
            
            const issueBody = `## ğŸ¤– Claude ã‚¿ã‚¹ã‚¯å®Ÿè¡Œçµæœ
            
            **å®Ÿè¡Œæ™‚åˆ»**: ${timestamp}
            **ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: ${taskType}
            **ãƒ¢ãƒ‡ãƒ«**: ${{ github.event.inputs.model }}
            
            ---
            
            ${resultContent}
            
            ---
            
            ### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
            
            ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š
            
            \`\`\`bash
            cd /home/ubuntu/webai
            ./github_actions_bypass.sh
            \`\`\`
            
            ã¾ãŸã¯ç›´æ¥Claude CLIã‚’ä½¿ç”¨ï¼š
            
            \`\`\`bash
            claude "ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œ" --model ${{ github.event.inputs.model }}
            \`\`\`
            `;
            
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ¤– Claude ã‚¿ã‚¹ã‚¯å®Ÿè¡Œ: ${taskType} - ${timestamp}`,
              body: issueBody,
              labels: ['claude-task', 'automated']
            });
            
            console.log(`Issue created: ${issue.data.html_url}`);